define(["animation","input","map","entity"],function(e,t,n,r){return{walk:function(e,n){if(this.data.event.stop)return this.data.event.stop=!1,!0;if(this.data.event.climb)return!0;t.keys.left||t.keys.right?(this.data.event.walk=!0,this.data.event.stand=!1):(this.data.event.walk=!1,this.data.event.stand=!0);if(t.keys.left&&t.keys.right){if(this.data.direction.right||this.data.direction.left)this.counter=0}else this.data.event.walk&&(t.keys.right===!0&&this.data.blocked.right===!1?this.data.x=this.data.x+this.data.walkSpeed:t.keys.left===!0&&this.data.blocked.left===!1&&(this.data.x=this.data.x-this.data.walkSpeed));t.keys.right===!1&&this.data.direction.right===!0&&(this.counter=0),t.keys.left===!1&&this.data.direction.left===!0&&(this.counter=0)},door:function(e,t){this.data.direction.left?this.data.x=(t.x-1)*32+15:this.data.direction.right&&(this.data.x=(t.x+1)*32+16)},climb:function(e,r){var i=function(e,t){for(var n=0;n<e.length;n++)if(e[n].group===t)return e[n];return!1},s=function(){this.data.fallRate=0,this.data.jumpRate=this.data.jumpForce,this.data.action="climb",this.data.event.jump=!1,this.data.event.fall=!1,this.data.y=this.data.y-1,this.data.onLand=!1,this.counter++,this.data.event.climb=!0},o=function(){this.data.fallRate=0,this.data.jumpRate=this.data.jumpForce,this.data.action="climb",this.data.event.jump=!1,this.data.event.fall=!1,this.data.y=this.data.y+1,this.data.onLand=!1,this.counter++,this.data.event.climb=!0},u=function(){!this.data.onLand&&this.data.event.climb&&(this.data.event.climb=!1,this.data.event.fall=!0)},a,f,l=this.data.tileX,c=this.data.tileY,h=n.collide(l,c),p=n.collide(l,c-1),d=n.collide(l,c+1);t.keys.up===!0?(this.data.event.jump||this.data.event.fall)&&!this.data.event.climb?s.call(this):i(h,"wall")&&i(h,"ladder")&&!i(p,"ladder")?s.call(this):i(h,"ladder")&&i(p,"ladder")?s.call(this):!i(h,"ladder")&&i(d,"ladder")&&this.data.event.climb?s.call(this):!i(h,"ladder")&&!i(p,"ladder")?u.call(this):u.call(this):t.keys.down===!0&&(i(h,"wall")&&i(h,"ladder")&&i(d,"ladder")?o.call(this):!i(h,"ladder")&&i(d,"ladder")?o.call(this):i(h,"ladder")&&i(d,"ladder")?o.call(this):i(h,"ladder")&&!i(d,"ladder")?u.call(this):u.call(this))},parseTilePosition:function(){var e=function(e){var t=Math.round(e/32);return t},t=this.animations[this.data.action].speed,n=this.counter,r=Math.floor(n/t);if(r>this.animations[this.data.action].frames.length-1||t===0)r=0,this.counter=0;this.data.frameData=this.animations[this.data.action].frames[r],this.data.tileX=e(this.data.x-this.data.frameData.cpx),this.data.tileY=e(this.data.y-this.data.frameData.cpy)},action:function(e,t){var r=function(e,t){if(e)for(var n=0;n<e.length;n++){!e[n];if(e[n].group===t)return e[n]}return!1},i,s,o,u,a=this.data.tileX,f=this.data.tileY;return o=n.collide(a,f),u=n.collide(a,f+1),r(o,"door")?this.on.door.call(this,e,{x:a,y:f}):r(o,"ladder")||r(u,"ladder")?this.on.climb.call(this,e,t):this.data.direction.left?(i=n.collide(a,f),s=r(i,"door"),s&&this.on.door.call(this,e,{x:a,y:f})):(a+=1,i=n.collide(a,f),s=r(i,"door"),s&&this.on.door.call(this,e,{x:a,y:f})),t},jump:function(e,n){!t.keys.space||this.data.jumpRate>=0||this.data.event.climb?(this.data.event.jump=!1,this.data.event.fall=!0):(this.data.event.jump===!1,this.data.onLand=!1,this.data.action="jump",this.data.event.jump=!0,this.data.y+=Math.floor(2*this.data.jumpRate),this.data.jumpRate+=e.world.data.gravity)},fall:function(e,t){this.data.action="fall",this.data.event.fall=!0,this.data.event.climb=!1,this.data.event.jump=!1,this.data.y+=Math.floor(2*this.data.fallRate),this.data.fallRate+=e.world.data.gravity},land:function(e,t){this.data.action="land",this.data.onLand=!0,this.data.event.jump=!1,this.data.event.fall=!1,this.data.event.climb=!1,this.data.fallRate=0,this.data.jumpRate=this.data.jumpForce},animate:function(n,r){if(!t.keys.left||!t.keys.right)if(t.keys.left||t.keys.right)t.keys.left&&(this.data.lastDirection="left"),t.keys.right&&(this.data.lastDirection="right"),this.data.action="walk";this.data.direction.left=this.data.lastDirection==="left",this.data.direction.right=this.data.lastDirection==="right",(this.data.event.action||t.keys.up||t.keys.down)&&this.data.event.climb===!1&&this.on.action.call(this,n,r),this.data.event.fall||!this.data.onLand&&!this.data.event.climb&&!this.data.event.jump?this.on.fall.call(this,n,r):this.data.event.jump||t.keys.space?this.on.jump.call(this,n,r):this.data.event.climb&&this.on.climb.call(this,n,r),(this.data.event.walk||t.keys.left||t.keys.right)&&this.on.walk.call(this,n,r),this.animations[this.data.action].speed>0&&this.data.event.climb===!1&&this.counter++;var i=this.animations[this.data.action].speed,s=Math.floor(this.counter/i);if(s>this.animations[this.data.action].frames.length-1||i===0)s=0,this.counter=0;var o=this.data.frameData=this.animations[this.data.action].frames[s];this.data.direction.left===!0?(this.data.isFlipped||(e.context.save(),e.context.scale(-1,1),e.context.translate(-e.canvas.width,0),this.data.isFlipped=!0),e.context.drawImage(this.image,o.x,o.y,o.w,o.h,e.canvas.width-(this.data.x-o.cpx)-o.w,this.data.y-o.cpy,o.w,o.h)):e.context.drawImage(this.image,o.x,o.y,o.w,o.h,this.data.x-o.cpx,this.data.y-o.cpy,o.w,o.h),this.on.resetCollisions.call(this)},collideBottom:function(e){this.data.event.fall&&(this.data.y=e.y*32-13,this.on.land.call(this)),this.data.onLand=!0,this.data.blocked.down=!0},collideTop:function(e){this.data.event.jump&&(this.data.event.jump=!1,this.data.event.fall=!0,this.data.action="fall"),this.data.blocked.up=!0},collideRight:function(e){this.data.action="stand",this.data.event.walk=!1,this.data.event.stand=!0,this.data.blocked.right=!0},collideLeft:function(e){this.data.action="stand",this.data.event.walk=!1,this.data.event.stand=!0,this.data.blocked.left=!0},resetCollisions:function(){this.data.action="stand",this.data.onLand=!1,this.data.blocked.left=!1,this.data.blocked.right=!1,this.data.blocked.up=!1,this.data.blocked.down=!1,this.data.isFlipped&&(e.context.restore(),this.data.isFlipped=!1),this.on.parseTilePosition.call(this)}}})